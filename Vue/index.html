<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue2Diff和Vue3Diff的区别 | Ronan&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/avatar.jpg">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.7b36eabc.css" as="style"><link rel="preload" href="/assets/js/app.5ab2ec69.js" as="script"><link rel="preload" href="/assets/js/2.eeb24f79.js" as="script"><link rel="preload" href="/assets/js/18.9da1d026.js" as="script"><link rel="prefetch" href="/assets/js/10.d0415309.js"><link rel="prefetch" href="/assets/js/11.11f96ddc.js"><link rel="prefetch" href="/assets/js/12.17cdedb4.js"><link rel="prefetch" href="/assets/js/13.b53a64a6.js"><link rel="prefetch" href="/assets/js/14.6127168f.js"><link rel="prefetch" href="/assets/js/15.c6fec423.js"><link rel="prefetch" href="/assets/js/16.551a14fc.js"><link rel="prefetch" href="/assets/js/17.3ad529cc.js"><link rel="prefetch" href="/assets/js/19.0ff8f3e6.js"><link rel="prefetch" href="/assets/js/3.1801cb39.js"><link rel="prefetch" href="/assets/js/4.30c96a68.js"><link rel="prefetch" href="/assets/js/5.f0e2ef51.js"><link rel="prefetch" href="/assets/js/6.e86df8f9.js"><link rel="prefetch" href="/assets/js/7.e76e2440.js"><link rel="prefetch" href="/assets/js/8.8df23d51.js"><link rel="prefetch" href="/assets/js/9.8c479be0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7b36eabc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/avatar.jpg" alt="Ronan's Blog" class="logo"> <span class="site-name can-hide">Ronan's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/Css/" class="nav-link">
  Css
</a></div><div class="nav-item"><a href="/Js/" class="nav-link">
  Js
</a></div><div class="nav-item"><a href="/Js+/" class="nav-link">
  Js高级
</a></div><div class="nav-item"><a href="/Ts/" class="nav-link">
  Ts
</a></div><div class="nav-item"><a href="/Vue/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/React/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/Network/" class="nav-link">
  Network
</a></div><div class="nav-item"><a href="/Webpack/" class="nav-link">
  Webpack
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Others/Git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/Others/Nginx/" class="nav-link">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/Others/Algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/Others/粤语/" class="nav-link">
  粤语
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/Css/" class="nav-link">
  Css
</a></div><div class="nav-item"><a href="/Js/" class="nav-link">
  Js
</a></div><div class="nav-item"><a href="/Js+/" class="nav-link">
  Js高级
</a></div><div class="nav-item"><a href="/Ts/" class="nav-link">
  Ts
</a></div><div class="nav-item"><a href="/Vue/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/React/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/Network/" class="nav-link">
  Network
</a></div><div class="nav-item"><a href="/Webpack/" class="nav-link">
  Webpack
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Others/Git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/Others/Nginx/" class="nav-link">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/Others/Algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/Others/粤语/" class="nav-link">
  粤语
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vue2Diff和Vue3Diff的区别</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Vue/#vue2diff和vue3diff的区别" class="sidebar-link">Vue2Diff和Vue3Diff的区别</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Vue/#vue3-coderwhy" class="sidebar-link">Vue3-coderwhy</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Vue/#vue3变化" class="sidebar-link">vue3变化</a></li><li class="sidebar-sub-header"><a href="/Vue/#diff算法的key" class="sidebar-link">diff算法的key</a></li><li class="sidebar-sub-header"><a href="/Vue/#methods中this指向" class="sidebar-link">methods中this指向</a></li><li class="sidebar-sub-header"><a href="/Vue/#setup函数不可以使用this" class="sidebar-link">setup函数不可以使用this</a></li><li class="sidebar-sub-header"><a href="/Vue/#生命周期函数变化" class="sidebar-link">生命周期函数变化</a></li><li class="sidebar-sub-header"><a href="/Vue/#reactive和ref" class="sidebar-link">reactive和ref</a></li><li class="sidebar-sub-header"><a href="/Vue/#torefs和toref" class="sidebar-link">toRefs和toRef</a></li><li class="sidebar-sub-header"><a href="/Vue/#watch和watcheffect" class="sidebar-link">watch和watchEffect</a></li><li class="sidebar-sub-header"><a href="/Vue/#作用域插槽" class="sidebar-link">作用域插槽</a></li><li class="sidebar-sub-header"><a href="/Vue/#vue插件" class="sidebar-link">vue插件</a></li><li class="sidebar-sub-header"><a href="/Vue/#vue源码三大模块" class="sidebar-link">vue源码三大模块</a></li><li class="sidebar-sub-header"><a href="/Vue/#block-tree" class="sidebar-link">Block Tree</a></li><li class="sidebar-sub-header"><a href="/Vue/#hmr热更新" class="sidebar-link">HMR热更新</a></li></ul></li><li><a href="/Vue/#vue3-小满zs" class="sidebar-link">vue3-小满zs</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Vue/#diff算法" class="sidebar-link">Diff算法</a></li><li class="sidebar-sub-header"><a href="/Vue/#ref系列" class="sidebar-link">Ref系列</a></li><li class="sidebar-sub-header"><a href="/Vue/#reactive系列" class="sidebar-link">Reactive系列</a></li><li class="sidebar-sub-header"><a href="/Vue/#to系列" class="sidebar-link">to系列</a></li><li class="sidebar-sub-header"><a href="/Vue/#源码学习" class="sidebar-link">源码学习</a></li><li class="sidebar-sub-header"><a href="/Vue/#vue3响应式原理实现" class="sidebar-link">vue3响应式原理实现</a></li><li class="sidebar-sub-header"><a href="/Vue/#computed实现" class="sidebar-link">computed实现</a></li><li class="sidebar-sub-header"><a href="/Vue/#样式bem架构" class="sidebar-link">样式BEM架构</a></li><li class="sidebar-sub-header"><a href="/Vue/#自定义指令" class="sidebar-link">自定义指令</a></li></ul></li><li><a href="/Vue/#vue3-zxq" class="sidebar-link">Vue3-zxq</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Vue/#浏览器环境访问vue实例对象" class="sidebar-link">浏览器环境访问Vue实例对象</a></li><li class="sidebar-sub-header"><a href="/Vue/#组件样式之css-module" class="sidebar-link">组件样式之CSS Module</a></li><li class="sidebar-sub-header"><a href="/Vue/#vue3-2-css绑定响应式数据" class="sidebar-link">vue3.2-css绑定响应式数据</a></li><li class="sidebar-sub-header"><a href="/Vue/#组件支持v-model" class="sidebar-link">组件支持v-model</a></li><li class="sidebar-sub-header"><a href="/Vue/#pinia" class="sidebar-link">Pinia</a></li><li class="sidebar-sub-header"><a href="/Vue/#mixins的覆盖与合并" class="sidebar-link">Mixins的覆盖与合并</a></li><li class="sidebar-sub-header"><a href="/Vue/#响应式实现案例" class="sidebar-link">响应式实现案例</a></li><li class="sidebar-sub-header"><a href="/Vue/#路由导航守卫" class="sidebar-link">路由导航守卫</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="vue2diff和vue3diff的区别"><a href="#vue2diff和vue3diff的区别" class="header-anchor">#</a> Vue2Diff和Vue3Diff的区别</h2> <ol><li><strong>双端 Diff 算法 vs 快速 Diff 算法</strong>：
<ul><li>Vue 2 使用的是双端 Diff算法（<strong>双端指针循环递归</strong>），它通过新旧节点的头尾对比以及交叉对比来寻找未移动的节点和可复用的节点。</li> <li>Vue 3 采用了快速 Diff 算法（<strong>双端比对+最长子序列</strong>），它借鉴了纯文本 Diff 算法中的预处理思路，通过构建新旧节点的位置映射表，并计算最长递增子序列来优化移动逻辑。</li></ul></li> <li><strong>全量 Diff vs 静态树提升</strong>：
<ul><li>Vue 2 执行全量 Diff，对所有节点进行比较。</li> <li>Vue 3 引入了<strong>静态树提升</strong>，通过编译阶段的静态分析来优化 Diff 过程，跳过静态节点的比较。</li></ul></li> <li><strong>性能优化</strong>：
<ul><li>Vue 3 的 Diff 算法在 Vue 2 的基础上进行了多项优化，包括更高效的节点比较、静态节点提升和块树优化，使得虚拟 DOM 的更新更加快速和高效。</li></ul></li> <li><strong>事件缓存</strong>：
<ul><li>Vue 3 引入了事件缓存机制，将事件处理函数缓存起来，避免每次渲染都重新创建，这有助于提高性能。</li></ul></li> <li><strong>静态标记</strong>：
<ul><li>Vue 3 为不同类型的节点添加了静态标记，这有助于 Diff 过程中的优化，例如跳过静态节点的比较。</li></ul></li> <li><strong>最长递增子序列</strong>：
<ul><li>Vue 3 使用最长递增子序列来优化节点的移动，减少实际的 DOM 操作。</li></ul></li> <li><strong>更新策略</strong>：
<ul><li>Vue 3 在更新策略上进行了优化，例如使用单向链表的方式，简化了子节点的比较过程。</li></ul></li> <li><strong>SSR 性能提升</strong>：
<ul><li>Vue 3 在服务端渲染（SSR）的性能上也做了优化，性能提升了 2 到 3 倍。</li></ul></li></ol> <p>Vue 3 的 Diff 算法相比 Vue 2 有显著的性能提升和优化，这些改进使得 Vue 3 在处理大规模应用时更加高效。</p> <h2 id="vue3-coderwhy"><a href="#vue3-coderwhy" class="header-anchor">#</a> Vue3-coderwhy</h2> <h3 id="vue3变化"><a href="#vue3变化" class="header-anchor">#</a> vue3变化</h3> <h4 id="源码层面"><a href="#源码层面" class="header-anchor">#</a> 源码层面</h4> <ol><li><p>通过<code>monorepo</code>形式管理源码</p> <ul><li><p>将许多项目的代码存储在同一个repository中</p></li> <li><p>目的是多个包本身相互独立，可以有自己的功能逻辑、单元测试等，同时又在同一个仓库下方便管理</p></li> <li><p>模块划分的更加清晰，可维护性、可扩展性更强</p></li></ul></li> <li><p><code>TypeScript</code>重写</p> <ul><li>Vue2中使用<code>FLow</code>（<strong>JS静态类型检查工具</strong>）进行类型检测</li> <li>Vue3使用TypeScript重构</li></ul></li></ol> <h4 id="性能层面"><a href="#性能层面" class="header-anchor">#</a> 性能层面</h4> <ol><li>使用<code>Proxy</code>进行数据劫持
<ul><li>Vue2是使用<code>Object.defineProperty</code>来劫持数据的getter和setter方法，缺陷就是当给对象添加或者删除属性时，是无法劫持和监听的，不得不提供一些特殊的API，比如<code>$set或$delete</code></li></ul></li> <li>删除不必要的API
<ul><li>移除了实例上的<code>$on, $off 和 $once</code>；</li> <li>移除了一些特性：如<code>filter、内联模板</code>等</li></ul></li> <li>编译优化
<ul><li><code>Block Tree、Slot编译优化、diff算法优化</code></li></ul></li></ol> <h4 id="新api"><a href="#新api" class="header-anchor">#</a> 新API</h4> <ol><li>由Options API 到 Composition API</li> <li><code>Hooks函数</code>增加代码的复用性
<ul><li>在Vue2的时候，我们通常通过<code>mixins</code>在多个组件之间共享逻辑，但是有一个很大的缺陷就是 mixins也是由一大堆的Options组成的，并且多个mixins会存在<strong>命名冲突</strong>的问题</li> <li>在Vue3中，我们可以通过<code>Hook函数</code>，来将一部分独立的逻辑抽取出去，并且它们还可以做到是响应式的</li></ul></li></ol> <h3 id="diff算法的key"><a href="#diff算法的key" class="header-anchor">#</a> diff算法的key</h3> <p><strong>作用</strong>：key属性主要用在Vue的虚拟DOM算法，在新旧nodes对比时辨识VNodes；</p> <p>​			有key，那么就使用 <code>patchKeyedChildren</code>方法；</p> <p>​			没有key，那么久使用 <code>patchUnkeyedChildren</code>方法；</p> <ul><li><p>如果不使用key，Vue会使用一种最大限度<strong>减少动态元素</strong>并且尽可能的尝试<strong>就地修改/复用相同类型元素</strong>的算法；</p> <p><img src="https://gitee.com/coderPjx/images/raw/master/images/Snipaste_2022-09-12_16-56-04.jpg" alt=""></p></li> <li><p>而使用key时，它会基于key的变化<strong>重新排列</strong>元素顺序，并且会<strong>移除/销毁key不存在的元素</strong></p> <ul><li><p>从头部遍历并patch</p> <p><img src="https://gitee.com/coderPjx/images/raw/master/images/Snipaste_2022-09-12_16-56-18.jpg" alt=""></p></li> <li><p>从尾部遍历并patch</p> <p><img src="https://gitee.com/coderPjx/images/raw/master/images/Snipaste_2022-09-12_16-56-22.jpg" alt=""></p></li> <li><p>旧节点遍历完毕，但是依然有新的节点，那么就新增节点</p> <p><img src="https://gitee.com/coderPjx/images/raw/master/images/Snipaste_2022-09-12_16-56-36.jpg" alt=""></p></li> <li><p>新的节点遍历完毕，但是依然有旧的节点，那么就移除旧节点</p> <p><img src="https://gitee.com/coderPjx/images/raw/master/images/Snipaste_2022-09-12_16-56-41.jpg" alt=""></p></li> <li><p>中间还有很多未知的或者乱序的节点</p> <p><img src="https://gitee.com/coderPjx/images/raw/master/images/Snipaste_2022-09-12_16-56-47.jpg" alt=""></p></li></ul></li></ul> <p>源码位置：packages--&gt;runtime-core--&gt;src--&gt;rerender.ts</p> <p>不绑定key：</p> <ol><li>选择新旧VNodes中长度短的进行<strong>遍历并patch所有VNodes(效率低)。</strong></li> <li>如果旧的节点比新节点少 添加节点执行mountChildern</li> <li>如果旧的节点比新节点多 删除节点执行unmountChildren。</li></ol> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">patchUnkeyedChildren</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
    c1<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    c2<span class="token operator">:</span> VNodeArrayChildren<span class="token punctuation">,</span>
    container<span class="token operator">:</span> RendererElement<span class="token punctuation">,</span>
    anchor<span class="token operator">:</span> RendererNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    parentComponent<span class="token operator">:</span> ComponentInternalInstance <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    parentSuspense<span class="token operator">:</span> SuspenseBoundary <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    isSVG<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
    slotScopeIds<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    optimized<span class="token operator">:</span> <span class="token builtin">boolean</span>
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    c1 <span class="token operator">=</span> c1 <span class="token operator">||</span> <span class="token constant">EMPTY_ARR</span>
    c2 <span class="token operator">=</span> c2 <span class="token operator">||</span> <span class="token constant">EMPTY_ARR</span>
      <span class="token comment">// todo 旧节点和新节点长度取最小值遍历patch</span>
    <span class="token keyword">const</span> oldLength <span class="token operator">=</span> c1<span class="token punctuation">.</span>length
    <span class="token keyword">const</span> newLength <span class="token operator">=</span> c2<span class="token punctuation">.</span>length
    <span class="token keyword">const</span> commonLength <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>oldLength<span class="token punctuation">,</span> newLength<span class="token punctuation">)</span>
    <span class="token keyword">let</span> i
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> commonLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> nextChild <span class="token operator">=</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> optimized
        <span class="token operator">?</span> <span class="token function">cloneIfMounted</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// todo patch打补丁 可以理解为对虚拟节点进行更新</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>
        c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        nextChild<span class="token punctuation">,</span>
        container<span class="token punctuation">,</span>
        <span class="token keyword">null</span><span class="token punctuation">,</span>
        parentComponent<span class="token punctuation">,</span>
        parentSuspense<span class="token punctuation">,</span>
        isSVG<span class="token punctuation">,</span>
        slotScopeIds<span class="token punctuation">,</span>
        optimized
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
      <span class="token comment">// todo 如果旧的节点比新节点多 删除节点unmount</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldLength <span class="token operator">&gt;</span> newLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// remove old</span>
      <span class="token function">unmountChildren</span><span class="token punctuation">(</span>
        c1<span class="token punctuation">,</span>
        parentComponent<span class="token punctuation">,</span>
        parentSuspense<span class="token punctuation">,</span>
        <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        commonLength
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// todo 如果旧的节点比新节点少 添加节点mount</span>
      <span class="token comment">// mount new</span>
      <span class="token class-name">mountChildren</span><span class="token punctuation">(</span>
        c2<span class="token punctuation">,</span>
        container<span class="token punctuation">,</span>
        anchor<span class="token punctuation">,</span>
        parentComponent<span class="token punctuation">,</span>
        parentSuspense<span class="token punctuation">,</span>
        isSVG<span class="token punctuation">,</span>
        slotScopeIds<span class="token punctuation">,</span>
        optimized<span class="token punctuation">,</span>
        commonLength
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>绑定key：</p> <ol><li>先从新旧VNodes<code>头部</code>开始遍历，通过<code>isSameVNodeType</code>比较VNode的type和key是否一样，一样遍历继续，不一样break跳出循环。</li> <li>再从新旧VNodes<code>尾部</code>开始遍历，通过<code>isSameVNodeType</code>比较VNode的type和key是否一样，一样遍历继续，不一样break跳出循环。</li> <li>首尾遍历都结束后，如果新VNodes更长，就添加新节点执行mount</li> <li>如果旧VNodes更长，就删除旧节点执行unmount</li> <li>如果中间存在<strong>无序</strong>VNodes，<strong>使用key建立索引Map，最大程度复用旧节点</strong> <ul><li>遍历无序的VNodes，通过map建立key和index的索引</li> <li>移除新节点队列中不存在的旧节点并更新复用节点</li> <li>处理新增节点与移动的节点(动态规划和二分查找实现<strong>最长递增子序列算法</strong>)</li></ul></li></ol> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// patchKeyedChildren方法的部分代码</span>
<span class="token keyword">const</span> <span class="token function-variable function">patchKeyedChildren</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
    c1<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    c2<span class="token operator">:</span> VNodeArrayChildren<span class="token punctuation">,</span>
    container<span class="token operator">:</span> RendererElement<span class="token punctuation">,</span>
    parentAnchor<span class="token operator">:</span> RendererNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    parentComponent<span class="token operator">:</span> ComponentInternalInstance <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    parentSuspense<span class="token operator">:</span> SuspenseBoundary <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    isSVG<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
    slotScopeIds<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    optimized<span class="token operator">:</span> <span class="token builtin">boolean</span>
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">const</span> l2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length
    <span class="token keyword">let</span> e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">// prev ending index</span>
    <span class="token keyword">let</span> e2 <span class="token operator">=</span> l2 <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">// next ending index</span>
	<span class="token comment">// todo 从头部开始遍历</span>
    <span class="token comment">// 1. sync from start</span>
    <span class="token comment">// (a b) c</span>
    <span class="token comment">// (a b) d e</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> n1 <span class="token operator">=</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">const</span> n2 <span class="token operator">=</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> optimized
        <span class="token operator">?</span> <span class="token function">cloneIfMounted</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// todo 节点类型和key值相同 继续遍历并patch 否则跳出循环</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patch</span><span class="token punctuation">(</span>
          n1<span class="token punctuation">,</span>
          n2<span class="token punctuation">,</span>
          container<span class="token punctuation">,</span>
          <span class="token keyword">null</span><span class="token punctuation">,</span>
          parentComponent<span class="token punctuation">,</span>
          parentSuspense<span class="token punctuation">,</span>
          isSVG<span class="token punctuation">,</span>
          slotScopeIds<span class="token punctuation">,</span>
          optimized
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
      i<span class="token operator">++</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// todo 从尾部开始遍历</span>
    <span class="token comment">// 2. sync from end</span>
    <span class="token comment">// a (b c)</span>
    <span class="token comment">// d e (b c)</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> n1 <span class="token operator">=</span> c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span>
      <span class="token keyword">const</span> n2 <span class="token operator">=</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token operator">=</span> optimized
        <span class="token operator">?</span> <span class="token function">cloneIfMounted</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patch</span><span class="token punctuation">(</span>
          n1<span class="token punctuation">,</span>
          n2<span class="token punctuation">,</span>
          container<span class="token punctuation">,</span>
          <span class="token keyword">null</span><span class="token punctuation">,</span>
          parentComponent<span class="token punctuation">,</span>
          parentSuspense<span class="token punctuation">,</span>
          isSVG<span class="token punctuation">,</span>
          slotScopeIds<span class="token punctuation">,</span>
          optimized
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
      e1<span class="token operator">--</span>
      e2<span class="token operator">--</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
    <span class="token comment">// 新增节点 mount</span>
    <span class="token comment">// 3. common sequence + mount</span>
        <span class="token comment">// (a b)</span>
        <span class="token comment">// (a b) c</span>
        <span class="token comment">// i = 2, e1 = 1, e2 = 2</span>
        <span class="token comment">// (a b)</span>
        <span class="token comment">// c (a b)</span>
        <span class="token comment">// i = 0, e1 = -1, e2 = 0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> nextPos <span class="token operator">=</span> e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> anchor <span class="token operator">=</span> nextPos <span class="token operator">&lt;</span> l2 <span class="token operator">?</span> c2<span class="token punctuation">[</span>nextPos<span class="token punctuation">]</span><span class="token punctuation">.</span>el <span class="token operator">:</span> parentAnchor<span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> optimized
                        <span class="token operator">?</span> <span class="token function">cloneIfMounted</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                        <span class="token operator">:</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG<span class="token punctuation">,</span> slotScopeIds<span class="token punctuation">,</span> optimized<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    i<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>  
      	<span class="token comment">// 删除节点 unmount</span>
        <span class="token comment">// 4. common sequence + unmount</span>
        <span class="token comment">// (a b) c</span>
        <span class="token comment">// (a b)</span>
        <span class="token comment">// i = 2, e1 = 2, e2 = 1</span>
        <span class="token comment">// a (b c)</span>
        <span class="token comment">// (b c)</span>
        <span class="token comment">// i = 0, e1 = 0, e2 = -1</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">unmount</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    
    <span class="token comment">// 5. unknown sequence</span>
    <span class="token comment">// 未知的节点序列</span>
    <span class="token comment">// [i ... e1 + 1]: a b [c d e] f g</span>
    <span class="token comment">// [i ... e2 + 1]: a b [e d c h] f g</span>
    <span class="token comment">// i = 2, e1 = 4, e2 = 5</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> s1 <span class="token operator">=</span> i<span class="token punctuation">;</span> <span class="token comment">// prev starting index</span>
            <span class="token keyword">const</span> s2 <span class="token operator">=</span> i<span class="token punctuation">;</span> <span class="token comment">// next starting index</span>
            <span class="token comment">// 5.1 build key:index map for newChildren</span>
            <span class="token comment">// 将新旧节点中的相同节点建立map索引，以便能复用节点</span>
            <span class="token keyword">const</span> keyToNewIndexMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> s2<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> nextChild <span class="token operator">=</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> optimized
                    <span class="token operator">?</span> <span class="token function">cloneIfMounted</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token operator">:</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Duplicate keys found during update:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Make sure keys are unique.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 5.2 loop through old children left to be patched and try to patch</span>
            <span class="token comment">// matching nodes &amp; remove nodes that are no longer present</span>
            <span class="token comment">// 移除新节点队列中不存在的旧节点并更新复用节点</span>
            <span class="token keyword">let</span> j<span class="token punctuation">;</span>
            <span class="token keyword">let</span> patched <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> toBePatched <span class="token operator">=</span> e2 <span class="token operator">-</span> s2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> moved <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">// used to track whether any node has moved</span>
            <span class="token keyword">let</span> maxNewIndexSoFar <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">// works as Map&lt;newIndex, oldIndex&gt;</span>
            <span class="token comment">// Note that oldIndex is offset by +1</span>
            <span class="token comment">// and oldIndex = 0 is a special value indicating the new node has</span>
            <span class="token comment">// no corresponding old node.</span>
            <span class="token comment">// used for determining longest stable subsequence</span>
            <span class="token keyword">const</span> newIndexToOldIndexMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span></span><span class="token punctuation">(</span>toBePatched<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> toBePatched<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                newIndexToOldIndexMap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> s1<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> e1<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> prevChild <span class="token operator">=</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>patched <span class="token operator">&gt;=</span> toBePatched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// all new children have been patched so this can only be a removal</span>
                    <span class="token function">unmount</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">let</span> newIndex<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    newIndex <span class="token operator">=</span> keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// key-less node, try to locate a key-less node of the same type</span>
                    <span class="token class-name"><span class="token keyword">for</span></span> <span class="token punctuation">(</span>j <span class="token operator">=</span> s2<span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> e2<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndexToOldIndexMap<span class="token punctuation">[</span>j <span class="token operator">-</span> s2<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                            <span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> c2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            newIndex <span class="token operator">=</span> j<span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">unmount</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    newIndexToOldIndexMap<span class="token punctuation">[</span>newIndex <span class="token operator">-</span> s2<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">&gt;=</span> maxNewIndexSoFar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        maxNewIndexSoFar <span class="token operator">=</span> newIndex<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        moved <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">patch</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> c2<span class="token punctuation">[</span>newIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG<span class="token punctuation">,</span> slotScopeIds<span class="token punctuation">,</span> optimized<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    patched<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 5.3 move and mount</span>
           	<span class="token comment">// 处理新增节点与移动的节点 getSequence求最长递增子序列</span>
            <span class="token comment">// generate longest stable subsequence only when nodes have moved</span>
            <span class="token keyword">const</span> increasingNewIndexSequence <span class="token operator">=</span> moved
                <span class="token operator">?</span> <span class="token function">getSequence</span><span class="token punctuation">(</span>newIndexToOldIndexMap<span class="token punctuation">)</span>
                <span class="token operator">:</span> shared<span class="token punctuation">.</span><span class="token constant">EMPTY_ARR</span><span class="token punctuation">;</span>
            j <span class="token operator">=</span> increasingNewIndexSequence<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment">// looping backwards so that we can use last patched node as anchor</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> toBePatched <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> nextIndex <span class="token operator">=</span> s2 <span class="token operator">+</span> i<span class="token punctuation">;</span>
                <span class="token keyword">const</span> nextChild <span class="token operator">=</span> c2<span class="token punctuation">[</span>nextIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> anchor <span class="token operator">=</span> nextIndex <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> l2 <span class="token operator">?</span> c2<span class="token punctuation">[</span>nextIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el <span class="token operator">:</span> parentAnchor<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndexToOldIndexMap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// mount new</span>
                    <span class="token class-name">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> nextChild<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG<span class="token punctuation">,</span> slotScopeIds<span class="token punctuation">,</span> optimized<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>moved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// move if:</span>
                    <span class="token comment">// There is no stable subsequence (e.g. a reverse)</span>
                    <span class="token comment">// OR current node is not among the stable sequence</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> i <span class="token operator">!==</span> increasingNewIndexSequence<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">move</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token comment">/* REORDER */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        j<span class="token operator">--</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      
</code></pre></div><h4 id="求最长递增子序列"><a href="#求最长递增子序列" class="header-anchor">#</a> 求最长递增子序列</h4> <p>动态规划+二分查找</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// https://en.wikipedia.org/wiki/Longest_increasing_subsequence</span>
<span class="token keyword">function</span> <span class="token function">getSequence</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> p <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> u<span class="token punctuation">,</span> v<span class="token punctuation">,</span> c<span class="token punctuation">;</span>
    <span class="token keyword">const</span> len <span class="token operator">=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> arrI <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arrI <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            j <span class="token operator">=</span> result<span class="token punctuation">[</span>result<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> arrI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> j<span class="token punctuation">;</span>
                result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            u <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            v <span class="token operator">=</span> result<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>u <span class="token operator">&lt;</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                c <span class="token operator">=</span> <span class="token punctuation">(</span>u <span class="token operator">+</span> v<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>result<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> arrI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    u <span class="token operator">=</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    v <span class="token operator">=</span> c<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>arrI <span class="token operator">&lt;</span> arr<span class="token punctuation">[</span>result<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">[</span>u <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                result<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    u <span class="token operator">=</span> result<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    v <span class="token operator">=</span> result<span class="token punctuation">[</span>u <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>u<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span>
        v <span class="token operator">=</span> p<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="methods中this指向"><a href="#methods中this指向" class="header-anchor">#</a> methods中this指向</h3> <ul><li><p>methods中不能使用箭头函数，因为箭头函数中this绑定了父级作用域的上下文，this不会指向组件实例对象而是<code>window</code></p></li> <li><p>源码中遍历了methods选项中的所有函数并通过<code>bind</code>绑定<strong>publicThis</strong>，publicThis实际上是instance.proxy代理对象，也就是<strong>响应式数据</strong>。在模板中@click触发事件时，实际是调用**ctx[key]**的函数。</p> <p>源码位置：packages--&gt;runtime-core--&gt;src--&gt;componentOptions.ts</p></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> publicThis <span class="token operator">=</span> instance<span class="token punctuation">.</span>proxy<span class="token operator">!</span>
<span class="token keyword">const</span> ctx <span class="token operator">=</span> instance<span class="token punctuation">.</span>ctx
<span class="token operator">...</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历methods选项中的所有方法</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> methodHandler <span class="token operator">=</span> <span class="token punctuation">(</span>methods <span class="token keyword">as</span> MethodOptions<span class="token punctuation">)</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>methodHandler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// In dev mode, we use the `createRenderContext` function to define methods to the proxy target,</span>
        <span class="token comment">// and those are read-only but reconfigurable, so it needs to be redefined here</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">methodHandler</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>publicThis<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          ctx<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">methodHandler</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>publicThis<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          checkDuplicateProperties<span class="token operator">!</span><span class="token punctuation">(</span>OptionTypes<span class="token punctuation">.</span><span class="token constant">METHODS</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; has type &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">typeof</span> methodHandler<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; in the component definition. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Did you reference the function correctly?</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="setup函数不可以使用this"><a href="#setup函数不可以使用this" class="header-anchor">#</a> setup函数不可以使用this</h3> <p>不是因为<code>setup</code>执行时组件实例还没有被创建出来。</p> <p>是因为<code>this</code>在vue内部执行时没有像methods中一样指向<code>publicThis</code>，并且在setup被调用之前，data、computed、methods等都没有被解析。所以没有指向当前组件实例，访问不到</p> <h3 id="生命周期函数变化"><a href="#生命周期函数变化" class="header-anchor">#</a> 生命周期函数变化</h3> <p>因为<code>setup</code>是围绕<code>beforeCreate</code>和<code>created</code>生命周期函数运行的，所以不需要显式定义。这些钩子函数应该直接在setup函数中编写。</p> <p><img src="https://gitee.com/coderPjx/images/raw/master/images/20230820171126.png" alt=""></p> <h3 id="reactive和ref"><a href="#reactive和ref" class="header-anchor">#</a> reactive和ref</h3> <ul><li>reactive API对<strong>传入的类型是有限制的</strong>，它要求我们必须传入的是<strong>一个对象或者数组类型</strong>，如果我们传入一个基本数据类型（String、Number、Boolean）会报一个警告</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">18</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>ref 会返回一个可变的响应式对象，该对象作为一个 <strong>响应式的引用</strong> 维护着它内部的值，这就是ref名称的来源；它内部的值是在ref的 value 属性中被维护的</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'Hello World'</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>注意事项</strong></p> <ol><li><p>在模板中引入ref的值时，Vue会帮助我们进行<strong>自动解包</strong>操作，所以我们并不需要在模板中通过 ref.value 的方式</p> <p>来使用</p></li> <li><p>但是在 setup 函数内部，它依然是一个 ref引用， 所以对其进行操作时，我们依然需要使用 <strong>ref.value</strong>的方式</p></li></ol> <h3 id="torefs和toref"><a href="#torefs和toref" class="header-anchor">#</a> toRefs和toRef</h3> <ul><li><p>如果我们使用<strong>ES6的解构语法</strong>，对reactive返回的对象进行解构获取值，那么之后无论是<strong>修改解构后的变量</strong>，还是<strong>修改reactive</strong></p> <p><strong>返回的state对象</strong>，<strong>数据都不再是响应式</strong>的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">nage</span><span class="token operator">:</span><span class="token string">'Tom'</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">18</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> nage<span class="token punctuation">,</span>age <span class="token punctuation">}</span> <span class="token operator">=</span> state<span class="token punctuation">;</span>
</code></pre></div><p>Vue为我们提供了一个<strong>toRefs</strong>的函数，可以将reactive返回的对象中的属性都转成ref</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// toRefs函数会返回两个ref对象，他们都是响应式的</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>name<span class="token punctuation">,</span>age<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">toRefs</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这种做法相当于已经在state.name和ref.value之间建立了链接，任何一个修改都会引起另外一个变化</p></li> <li><p>如果我们只希望转换一个<strong>reactive对象中的属性为ref</strong>,那么可以使用<strong>toRef</strong>的方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token function">toRef</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span><span class="token string">'name'</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h3 id="watch和watcheffect"><a href="#watch和watcheffect" class="header-anchor">#</a> watch和watchEffect</h3> <p>watch与watchEffect的比较，watch允许我们:</p> <ul><li><p>懒执行副作用（第一次不会直接执行）,watchEffect由于<strong>flush参数</strong>默认值为<code>pre</code>，会在dom更新前执行一次；</p></li> <li><p>指定当某些（单个和多个，<strong>多个使用数组传入</strong>）状态发生变化时，触发侦听器的执行；</p></li> <li><p>访问侦听状态变化前后的值（newValue、oldValue）；</p></li></ul> <p>watchEffect用于<strong>自动收集</strong>响应式数据的依赖，watch需要<strong>手动指定</strong>侦听的数据源</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'watchEffect执行'</span><span class="token punctuation">,</span>name<span class="token punctuation">.</span>value<span class="token punctuation">,</span>age<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><strong>watchEffect的停止侦听</strong></li></ul> <p>​	如果在发生某些情况下，我们希望停止侦听，这个时候我们可以获取watchEffect的返回值函数，<strong>调用函数</strong>即可</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> stopWatch <span class="token operator">=</span> <span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'watchEffect执行'</span><span class="token punctuation">,</span>name<span class="token punctuation">.</span>value<span class="token punctuation">,</span>age<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">changeAge</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	age<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>age<span class="token punctuation">.</span>value <span class="token operator">&gt;</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">stopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><strong>watchEffect清除副作用</strong></li></ul> <p>​	给watchEffect传入的函数被回调时，其实可以获取到一个参数：<strong>onInvalidate</strong></p> <p>​	当<strong>副作用即将重新执行</strong> 或者 <strong>侦听器被停止</strong> 时会执行该函数传入的回调函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> stopWatch <span class="token operator">=</span> <span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">onInvalidate</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'watchEffect执行'</span><span class="token punctuation">,</span>name<span class="token punctuation">.</span>value<span class="token punctuation">,</span>age<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">settimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2s后执行'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>，<span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">onInvalidate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><strong>watchEffect的执行时机</strong></li></ul> <p>默认情况下，组件的更新会在副作用函数执行之前。</p> <p>如果我们希望在副作用函数中获取到元素，是否可行呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> titleRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>titleRef<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        titleRef
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>实际结果为打印了两次：第一次为<strong>null</strong>，第二次才是获取到的<strong>DOM元素</strong></p> <p>这是因为setup函数在执行时就会立即执行传入的副作用函数，这个时候DOM并没有挂载，所以打印为null</p> <p>而当DOM挂载时，会给title的ref对象赋值新的值，副作用函数会再次执行，打印出来对应的元素</p> <ul><li><strong>调整watchEffect的执行时机</strong></li></ul> <p>如果我们希望在第一次的时候就打印出来对应的元素呢？我们需要设置<strong>flush参数</strong>改变副作用函数的执行时机。</p> <p><strong>它的默认值是pre，它会在元素 挂载 或者 更新 之前执行</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>titleRef<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>，<span class="token punctuation">{</span>
    	<span class="token literal-property property">flush</span><span class="token operator">:</span><span class="token string">&quot;post&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>flush 选项还接受 <strong>sync</strong>，为每个更改都强制触发侦听器。然而，这是低效的，应该很少需要</p> <h3 id="作用域插槽"><a href="#作用域插槽" class="header-anchor">#</a> <strong>作用域插槽</strong></h3> <ol><li><p>在App.vue中定义好数据，并通过props传递给子组件</p></li> <li><p>在子组件中的slot上定义插槽的prop</p></li> <li><p>父组件通过v-slot:default的方式获取到slot的props</p></li> <li><p>使用slotProps中的item和index</p></li></ol> <div class="language-vue extra-class"><pre class="language-vue"><code>// App.vue
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-cpn</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name"><span class="token namespace">v-slot:</span>default</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>slotProps<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>{{slotProps.item}}-{{slotProps.index}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-cpn</span><span class="token punctuation">&gt;</span></span>

data() {
    return {
        names:['Jack','Tom','Ronan']
    }
}
</code></pre></div><div class="language-vue extra-class"><pre class="language-vue"><code>// childCpn.vue
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(item,index) in names<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token attr-name">:item</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

...
props:{
	names:{
		type:Array,
		default：() =&gt; []
	}
}
</code></pre></div><h3 id="vue插件"><a href="#vue插件" class="header-anchor">#</a> vue插件</h3> <p><code>app.use(pluginName,opts)</code>可以在vue实例中安装插件</p> <p>插件可以是一个带 <code>install()</code> 方法的<strong>对象</strong>，亦或直接是一个将被用作 <code>install()</code> 方法的<strong>函数</strong>。</p> <p>若 <code>app.use()</code> 对同一个插件多次调用，该插件只会被安装一次.</p> <p>类似<code>vue router</code>和<code>vuex</code>等插件实现原理都是如此，通过install方法对app实例进行操作</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 函数插件</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> opt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;functionPlugin app&quot;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;functionPlugin opt&quot;</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;functionPlugin app.config&quot;</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 对象插件</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
	<span class="token function">install</span><span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> opt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;objectPlugin app&quot;</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;objectPlugin opt&quot;</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">;</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;objectPlugin app.config&quot;</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// main.js</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>functionPlugin<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">opt</span><span class="token operator">:</span><span class="token number">123</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>objectPlugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="vue源码三大模块"><a href="#vue源码三大模块" class="header-anchor">#</a> vue源码三大模块</h3> <p>1.compiler 编译模块</p> <ul><li><code>template</code>   -&gt;   <code>render函数</code> <ul><li>runtime-only环境：依赖<code>vue-loader</code>和<code>vue/compiler-sfc</code>实现转换</li></ul></li></ul> <p>2.runtime（render）渲染模块</p> <ul><li><code>render函数</code>返回<code>vNode</code>组成<code>虚拟DOM</code>   -&gt;   <code>挂载</code>   -&gt;   <code>真实DOM</code></li></ul> <p>3.reactivity 响应式模块</p> <ul><li><code>data</code>或<code>setup</code>中的数据更新   -&gt;   <code>构建新的vNode</code>   -&gt;  <code>patch</code>方法中通过 <code>diff算法</code>  新旧节点对比进行更新 -&gt;   真实DOM进行修改</li></ul> <p><img src="https://gitee.com/coderPjx/images/raw/master/images/Snipaste_2022-10-23_17-11-41.jpg" alt=""></p> <h4 id="渲染模块简易实现"><a href="#渲染模块简易实现" class="header-anchor">#</a> 渲染模块简易实现</h4> <ol><li><p><code>h函数</code>  用于返回一个VNode对象</p></li> <li><p><code>mount函数</code>  用于将VNode挂载到DOM上</p> <ul><li><p>根据tag，创建HTML元素，并且存储到vnode的el中；</p></li> <li><p>处理props属性</p> <ul><li><p>如果以on开头，那么监听事件；</p></li> <li><p>普通属性直接通过 setAttribute 添加即可；</p></li></ul></li> <li><p>处理children子节点</p> <ul><li><p>如果是字符串节点，那么直接设置textContent；</p></li> <li><p>如果是数组节点，那么遍历调用 mount 函数；</p></li></ul></li></ul></li> <li><p><code>patch函数</code> 用于对两个VNode进行对比，决定如何处理新的VNode</p> <ul><li><p>n1和n2是不同类型的节点：</p> <ul><li><p>找到n1的el父节点，删除原来的n1节点的el；</p></li> <li><p>挂载n2节点到n1的el父节点上；</p></li></ul></li> <li><p>n1和n2节点是相同的节点：</p> <ul><li><p>处理props的情况</p> <ul><li><p>先将新节点的props全部挂载到el上；</p></li> <li><p>判断旧节点的props是否不需要在新节点上，如果不需要，那么删除对应的属性；</p></li></ul></li> <li><p>处理children的情况</p> <ul><li>如果新节点为string
<ul><li>旧节点为string，值不一样，调用 el.textContent = newChildren；</li> <li>旧节点为array，调用el.innerHTML = newChildren;</li></ul></li> <li>如果新节点为array
<ul><li>旧节点为string,将el的textContent设置为空字符串,遍历新节点调用mount，挂载到el上；</li> <li>旧节点为array</li> <li>取出数组的最小长度, 遍历所有的节点，新节点和旧节点进行path操作；</li> <li>如果新节点的length更长，那么剩余的新节点进行挂载操作；</li> <li>如果旧节点的length更长，那么剩余的旧节点进行卸载操作；</li></ul></li></ul></li></ul></li></ul></li></ol> <p>index.html</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
			<span class="token selector">.div-title</span> <span class="token punctuation">{</span>
				<span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token selector">.h2-title</span> <span class="token punctuation">{</span>
				<span class="token property">color</span><span class="token punctuation">:</span> aquamarine<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./render.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!-- 渲染器实现 --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
			<span class="token comment">// 1.h函数返回vNode</span>
			<span class="token keyword">const</span> vNode1 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;div-title&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
				<span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;h2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;h2-title&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello Vue3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;我是span&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 2.mount函数实现挂载vNode到真实Dom</span>
			<span class="token function">mount</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 3.创建新的vNode</span>
			<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> vNode2 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;span-title&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&quot;aaa&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
					<span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;h2&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;呵呵呵&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;button&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">patch</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><p>render.js</p> <p>h函数 <code>返回vNode对象</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// h函数会返回vNode,而vNode本质就是js对象 {}</span>
<span class="token keyword">const</span> <span class="token function-variable function">h</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">{</span>
		tag<span class="token punctuation">,</span>
		props<span class="token punctuation">,</span>
		children<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>mount函数  <code>vNode对象转变成真实元素并挂载到指定元素</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">mount</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> <span class="token punctuation">{</span> tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children <span class="token punctuation">}</span> <span class="token operator">=</span> vNode<span class="token punctuation">;</span>
  <span class="token comment">// 1.处理tag</span>
	<span class="token comment">// 根据tag生成元素，并在vNode上追加el属性</span>
	<span class="token keyword">const</span> el <span class="token operator">=</span> <span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 2.处理props</span>
  <span class="token comment">// 遍历props并绑定到元素 如果是on开头表示绑定事件</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> props<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'on'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 3.处理children</span>
  <span class="token comment">// 如果是单个节点直接设置元素内容 多个节点递归调用mount</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> children <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span>textContent <span class="token operator">=</span> children
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">mount</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span>el<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 将生成的真实DOM追加到页面指定元素中</span>
	container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>patch函数 <code>对比新旧vNode,并通过diff算法决定如何处理新vNode</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// patch函数对比新旧vNode,并通过diff算法决定如何处理新vNode</span>
<span class="token keyword">const</span> <span class="token function-variable function">patch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1.处理tag</span>
	<span class="token comment">// 如果tag不一样，卸载旧node,在父元素mount新node</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>n1<span class="token punctuation">.</span>tag <span class="token operator">!==</span> n2<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> elParent <span class="token operator">=</span> n1<span class="token punctuation">.</span>el<span class="token punctuation">.</span>parentElement<span class="token punctuation">;</span>
		elParent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>n1<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">mount</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> elParent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// 2.处理props</span>
		<span class="token keyword">const</span> el <span class="token operator">=</span> <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>el <span class="token operator">=</span> n1<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> oldProps <span class="token operator">=</span> n1<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> newProps <span class="token operator">=</span> n2<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token comment">// 2.1 添加所有新props到el</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> newProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> newValue <span class="token operator">=</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token keyword">const</span> oldValue <span class="token operator">=</span> oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!==</span> oldValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// 添加事件监听</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;on&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// 添加其他属性</span>
				<span class="token keyword">else</span> <span class="token punctuation">{</span>
					el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 2.2 删除所有旧props</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 删除事件监听</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;on&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> oldValue <span class="token operator">=</span> oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
				el<span class="token punctuation">.</span><span class="token function">removeEventLister</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> newProps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// 删除其他属性</span>
				el<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 3.处理children children一般为string|array类型 共有2*2四种情况</span>
		<span class="token keyword">const</span> oldChildren <span class="token operator">=</span> n1<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> newChildren <span class="token operator">=</span> n2<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token comment">// 情况1 新children为string</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newChildren <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 情况1.1 旧children为string</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> oldChildren <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// 都为字符串且不相等 更新内容</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildren <span class="token operator">!==</span> newChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					el<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newChildren<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// 情况1.2 旧children为array</span>
				el<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> newChildren<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// 情况2 新children为array</span>
			<span class="token comment">// /情况2.1 旧children为string</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> oldChildren <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// 清空原有的内容并mount新children</span>
				el<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
				newChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
					<span class="token function">mount</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// 情况2.2 旧children为array 进行diff(此实现为简略版)</span>
				<span class="token comment">// oldChildren: [v1, v2, v3, v8, v9]</span>
				<span class="token comment">// newChildren: [v1, v5, v6]</span>
				<span class="token comment">// 1.前面有相同节点的元素进行patch操作</span>
				<span class="token keyword">const</span> commonLength <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">,</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> commonLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">patch</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// oldChildren: [v1, v2, v3]</span>
				<span class="token comment">// newChildren: [v1, v5, v6, v8, v9]</span>
				<span class="token comment">// 2.newChildren.length &gt; oldChildren.length 挂载新元素</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>newChildren<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					newChildren<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
						<span class="token function">mount</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// oldChildren: [v1, v2, v3, v8, v9]</span>
				<span class="token comment">// newChildren: [v1, v5, v6]</span>
				<span class="token comment">// 3.newChildren.length &lt; oldChildren.length 卸载旧元素</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>newChildren<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					oldChildren<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
						el<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="block-tree"><a href="#block-tree" class="header-anchor">#</a> Block Tree</h3> <p>简而言之：将节点<code>扁平化</code></p> <p><img src="https://gitee.com/coderPjx/images/raw/master/images/Snipaste_2022-11-13_16-09-28.jpg" alt=""></p> <ol><li><p>对静态节点（节点内容写死）进行提升（hoist）并提取，在创建虚拟节点时不用重复创建，在进行diff算法时不用处理静态节点。</p></li> <li><p><code>diff算法</code>的特点就是<code>递归</code>，每次比较同一层，进行全量比对</p> <ul><li><code>block</code>的作用就是为了<code>收集动态节点</code>（收集自己下面的所有的）</li> <li>将树的递归<code>扁平化</code>成一个数组</li> <li>在<code>createVNode</code>的时候，会判断这个节点是动态的，就让外层的block收集起来</li> <li>目的是为了<code>diff</code>的时候只<code>diff</code>动态节点</li></ul></li></ol> <h3 id="hmr热更新"><a href="#hmr热更新" class="header-anchor">#</a> HMR热更新</h3> <ul><li>开启：</li></ul> <p>默认情况下，webpack-dev-server已经支持HMR，我们只需要开启即可</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token literal-property property">devServer</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token literal-property property">hot</span><span class="token operator">:</span><span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是你会发现，当我们修改了某一个模块的代码时，依然是刷新的整个页面</p> <p>这是因为我们需要去<strong>指定哪些模块发生更新时，进行HMR</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token string">&quot;./utils.js&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'utils更新了'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><strong>注意：</strong></li></ul> <p>在开发其他项目时，我们不需要经常手动去写入 module.hot.accpet相关的API。</p> <ol><li><p>vue开发中，我们使用<strong>vue-loader</strong>，此loader支持vue组件的HMR，提供开箱即用的体验</p></li> <li><p>react开发中，有React Hot Loader，实时调整react组件（目前React官方已经弃用了，改成使用<strong>react</strong></p> <p><strong>refresh</strong>）</p></li></ol> <ul><li><p><strong>HMR原理</strong>：</p> <p>HMR的如何可以做到只更新一个模块中的内容呢？</p> <p>webpack-dev-server会创建两个服务：提供<strong>静态资源的服务</strong>（express）和<strong>Socket服务</strong>（net.Socket）。</p> <ol><li>express server负责直接提供静态资源的服务（打包后的资源直接被浏览器请求和解析）</li> <li>HMR Socket Server，是一个socket的长连接
<ul><li>长连接有一个最好的好处是建立连接后双方可以通信（服务器可以直接发送文件到客户端）；</li> <li>当服务器监听到对应的模块发生变化时，会生成两个文件.json（manifest文件）和.js文件（update chunk）；</li> <li>通过长连接，可以直接将这两个文件主动发送给客户端（浏览器）；</li> <li>浏览器拿到两个新的文件后，通过HMR runtime机制，加载这两个文件，并且针对修改的模块进行更新；</li></ul></li></ol></li></ul> <p><img src="https://gitee.com/coderPjx/images/raw/master/images/20230820154053.png" alt=""></p> <h2 id="vue3-小满zs"><a href="#vue3-小满zs" class="header-anchor">#</a> vue3-小满zs</h2> <h3 id="diff算法"><a href="#diff算法" class="header-anchor">#</a> Diff算法</h3> <p><strong>vue2和vue3 diff算法不同点</strong>：</p> <p>vue2中除了双端对比算法（头和头、尾和尾对比），还会进行头尾交叉对比算法（头和尾、尾和头对比）。vue3中不会进行头尾交叉对比算法，采用***最长递增子序列算法***进行优化。</p> <p><strong>vue3 diff算法</strong></p> <p>没有key:全量更新</p> <p>有key:</p> <ol><li>前序对比算法</li> <li>尾序对比算法</li> <li>新节点如果多出来，就是挂载</li> <li>旧节点如果多出来，就是卸载</li> <li>特殊情况乱序  最长递增子序列算法(贪心+二分)</li></ol> <h3 id="ref系列"><a href="#ref系列" class="header-anchor">#</a> Ref系列</h3> <h4 id="ref、shallowref、triggerref"><a href="#ref、shallowref、triggerref" class="header-anchor">#</a> **ref、shallowRef、triggerRef **</h4> <p>ref是深层次的响应，shallowRef是浅层次的响应。</p> <p>ref方法会<strong>递归遍历对象的所有属性</strong>，使其所有属性具有响应性，当对象属性多的时候，过多的监听会导致性能损耗。所以使用shallowRef更好</p> <p>当修改shallowRef的value中的属性，即使属性值被修改，视图不会发生改变。</p> <p>只有当修改shallowRef的value属性，或者搭配<strong>triggerRef</strong>使用强制更新时，修改才会同步到视图。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">shallowRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	<span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">18</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

data<span class="token punctuation">.</span>value<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token comment">// 视图不更新</span>
data<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">age</span> <span class="token operator">:</span><span class="token number">20</span> <span class="token punctuation">}</span> <span class="token comment">// 视图更新</span>

<span class="token comment">// 或者使用triggerRef</span>
data<span class="token punctuation">.</span>value<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token function">triggerRef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

</code></pre></div><p>注意点：</p> <p><strong>ref和shallowRef不要一起使用</strong>，因为ref底层也调用了<code>triggerRef</code>进行更新。一起使用时，ref的更新会造成<code>shallowRef</code>视图也更新。</p> <p><strong>reactive和shallowReactive同理</strong></p> <h4 id="customref"><a href="#customref" class="header-anchor">#</a> customRef</h4> <p>自定义ref，customRef 是个工厂函数要求我们返回一个对象 并且实现 get 和 set</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// customRef实现防抖</span>
<span class="token keyword">function</span> myRef<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> any<span class="token operator">&gt;</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token literal-property property">timer</span><span class="token operator">:</span>any<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">customRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">track<span class="token punctuation">,</span> trigger</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 手机依赖</span>
        <span class="token function">track</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> value
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
        timer <span class="token operator">=</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'触发了set'</span><span class="token punctuation">)</span>
          value <span class="token operator">=</span> newVal
          <span class="token comment">// 触发更新</span>
          <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> 
 
<span class="token keyword">const</span> name <span class="token operator">=</span> myRef<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">'aaa'</span><span class="token punctuation">)</span>
 
<span class="token keyword">const</span> <span class="token function-variable function">change</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'bbb'</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="reactive系列"><a href="#reactive系列" class="header-anchor">#</a> Reactive系列</h3> <h4 id="reactive"><a href="#reactive" class="header-anchor">#</a> reactive</h4> <p>用来绑定复杂的数据类型，例如对象、数组，不可以绑定普通的数据类型</p> <p>ref和reactive<strong>区别</strong>：</p> <ol><li>ref支持所有数据类型，reactive只支持Array、Object、Map、Set</li> <li>ref取值、赋值操作需要通过<code>.value</code>，reactive 不需要</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
   <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">&quot;aaa&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
person<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;bbb&quot;</span>
</code></pre></div><h4 id="shallowreactive"><a href="#shallowreactive" class="header-anchor">#</a> shallowReactive</h4> <p>只能对浅层的数据响应，如果是深层的数据只会改变值，不会改变视图</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">first</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token literal-property property">second</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
 
<span class="token keyword">function</span> <span class="token function">change1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  state<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">7</span> <span class="token comment">// 视图更新</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">change2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  state<span class="token punctuation">.</span>first<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">8</span>  <span class="token comment">// 数据修改，视图不更新</span>
  state<span class="token punctuation">.</span>first<span class="token punctuation">.</span>second<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">9</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="to系列"><a href="#to系列" class="header-anchor">#</a> to系列</h3> <p><strong>toRef、toRefs、toRaw</strong></p> <p>这3个方法都是只针对于<code>响应式对象</code>才有效。</p> <h4 id="toref"><a href="#toref" class="header-anchor">#</a> toRef</h4> <p>响应式对象的属性在<code>解构</code>后会<strong>失去响应性</strong>，toRef包裹后可以延续结构后属性的响应性。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
   <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token comment">// bar 转化为响应式对象</span>
<span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">toRef</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">change</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   state<span class="token punctuation">.</span>value<span class="token operator">++</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="torefs"><a href="#torefs" class="header-anchor">#</a> toRefs</h4> <p>toRefs本质是遍历响应式对象的所有属性，并执行toRef。</p> <h4 id="toraw"><a href="#toraw" class="header-anchor">#</a> toRaw</h4> <p>toRaw则是可以获取经过Proxy代理后的响应性对象的原生对象。本质是在Proxy代理后的对象中添加了一个<strong>私有属性__v_raw</strong>来保存原生对象</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 如果对象存在原始版本（即raw不为undefined），则递归调用toRaw函数</span>
<span class="token comment">// 如果对象不存在原始版本（即raw为undefined），则直接返回原始对象observed</span>
<span class="token keyword">function</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token parameter">observed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> raw <span class="token operator">=</span> observed <span class="token operator">&amp;&amp;</span> observed<span class="token punctuation">[</span><span class="token string">&quot;__v_raw&quot;</span> <span class="token comment">/* RAW */</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> raw <span class="token operator">?</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span> <span class="token operator">:</span> observed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="源码学习"><a href="#源码学习" class="header-anchor">#</a> 源码学习</h3> <h4 id="isref"><a href="#isref" class="header-anchor">#</a> isRef</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 根据私有属性__v_isRef判断是否为Ref对象</span>
<span class="token keyword">function</span> <span class="token function">isRef</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Boolean</span><span class="token punctuation">(</span>r <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>__v_isRef <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="ref"><a href="#ref" class="header-anchor">#</a> ref</h4> <p>如果传入值为对象，底层调用链最终会调用<code>reactive</code>实现</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 调用createRef，第二个参数为false代表深层对象</span>
<span class="token keyword">function</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createRef</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="shallowref"><a href="#shallowref" class="header-anchor">#</a> shallowRef</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 调用createRef，第二个参数为true代表浅层对象</span>
<span class="token keyword">function</span> <span class="token function">shallowRef</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createRef</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="createref"><a href="#createref" class="header-anchor">#</a> createRef</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createRef</span><span class="token punctuation">(</span><span class="token parameter">rawValue<span class="token punctuation">,</span> shallow</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果已经为ref对象，直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>rawValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> rawValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 非ref对象，调用RefImpl类创建实例对象</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RefImpl</span><span class="token punctuation">(</span>rawValue<span class="token punctuation">,</span> shallow<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="refimpl类"><a href="#refimpl类" class="header-anchor">#</a> RefImpl类</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 真正地创建ref对象</span>
<span class="token keyword">class</span> <span class="token class-name">RefImpl</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> _shallow</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_shallow <span class="token operator">=</span> _shallow<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// 依赖项，在trackRefValue中会收集</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>__v_isRef <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 后续根据这个属性判断是否为ref对象</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_rawValue <span class="token operator">=</span> _shallow <span class="token operator">?</span> value <span class="token operator">:</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保存原始对象的值</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> _shallow <span class="token operator">?</span> value <span class="token operator">:</span> <span class="token function">toReactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 收集依赖</span>
        <span class="token function">trackRefValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newVal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_shallow <span class="token operator">?</span> newVal <span class="token operator">:</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shared<span class="token punctuation">.</span><span class="token function">hasChanged</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rawValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_rawValue <span class="token operator">=</span> newVal<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_shallow <span class="token operator">?</span> newVal <span class="token operator">:</span> <span class="token function">toReactive</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 更新依赖</span>
            <span class="token function">triggerRefValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="toraw-2"><a href="#toraw-2" class="header-anchor">#</a> toRaw</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 如果对象存在原始版本（即raw不为undefined），则递归调用toRaw函数</span>
<span class="token comment">// 如果对象不存在原始版本（即raw为undefined），则直接返回原始对象observed</span>
<span class="token keyword">function</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token parameter">observed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> raw <span class="token operator">=</span> observed <span class="token operator">&amp;&amp;</span> observed<span class="token punctuation">[</span><span class="token string">&quot;__v_raw&quot;</span> <span class="token comment">/* RAW */</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> raw <span class="token operator">?</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span> <span class="token operator">:</span> observed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="toreactive"><a href="#toreactive" class="header-anchor">#</a> toReactive</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 如果传入值为对象调用reactive转为响应式对象，否则返回原始值</span>
<span class="token keyword">const</span> <span class="token function-variable function">toReactive</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> shared<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> value<span class="token punctuation">;</span>
</code></pre></div><h4 id="reactive-2"><a href="#reactive-2" class="header-anchor">#</a> reactive</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果对象为只读readonly直接返回</span>
    <span class="token comment">// if trying to observe a readonly proxy, return the readonly version.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">&amp;&amp;</span> target<span class="token punctuation">[</span><span class="token string">&quot;__v_isReadonly&quot;</span> <span class="token comment">/* IS_READONLY */</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mutableHandlers<span class="token punctuation">,</span> mutableCollectionHandlers<span class="token punctuation">,</span> reactiveMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> isReadonly<span class="token punctuation">,</span> baseHandlers<span class="token punctuation">,</span> collectionHandlers<span class="token punctuation">,</span> proxyMap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不是对象类型直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shared<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">value cannot be made reactive: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// target is already a Proxy, return it.</span>
    <span class="token comment">// exception: calling readonly() on a reactive object</span>
    <span class="token comment">// 已经被proxy代理，直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">[</span><span class="token string">&quot;__v_raw&quot;</span> <span class="token comment">/* RAW */</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span>isReadonly <span class="token operator">&amp;&amp;</span> target<span class="token punctuation">[</span><span class="token string">&quot;__v_isReactive&quot;</span> <span class="token comment">/* IS_REACTIVE */</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 从缓存（readonlyMap和reactiveMap，实际都为weakMap弱引用）查找，存在就直接返回</span>
    <span class="token comment">// target already has corresponding Proxy</span>
    <span class="token keyword">const</span> existingProxy <span class="token operator">=</span> proxyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> existingProxy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// only a whitelist of value types can be observed.</span>
    <span class="token comment">// 如果在白名单比如 有skip属性（markRaw实现）或对象不可扩展</span>
    <span class="token keyword">const</span> targetType <span class="token operator">=</span> <span class="token function">getTargetType</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>targetType <span class="token operator">===</span> <span class="token number">0</span> <span class="token comment">/* INVALID */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// targetType为2代表类型为map、set、weakMap、weakSet的某一个</span>
    <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> targetType <span class="token operator">===</span> <span class="token number">2</span> <span class="token comment">/* COLLECTION */</span> <span class="token operator">?</span> collectionHandlers <span class="token operator">:</span> baseHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    proxyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>getTargetType</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 对象有skip属性（markRaw实现）或者对象不可扩展，类型为0，否则调用targetTypeMap获取类型</span>
<span class="token keyword">function</span> <span class="token function">getTargetType</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value<span class="token punctuation">[</span><span class="token string">&quot;__v_skip&quot;</span> <span class="token comment">/* SKIP */</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token operator">!</span>Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token number">0</span> <span class="token comment">/* INVALID */</span>
        <span class="token operator">:</span> <span class="token function">targetTypeMap</span><span class="token punctuation">(</span>shared<span class="token punctuation">.</span><span class="token function">toRawType</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>targetTypeMap</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">targetTypeMap</span><span class="token punctuation">(</span><span class="token parameter">rawType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>rawType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 对象、数组类型为1</span>
        <span class="token keyword">case</span> <span class="token string">'Object'</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token string">'Array'</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token number">1</span> <span class="token comment">/* COMMON */</span><span class="token punctuation">;</span>
        <span class="token comment">// map、set、weakMap、weakSet类型为2</span>
        <span class="token keyword">case</span> <span class="token string">'Map'</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token string">'Set'</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token string">'WeakMap'</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token string">'WeakSet'</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token number">2</span> <span class="token comment">/* COLLECTION */</span><span class="token punctuation">;</span>
        <span class="token comment">// 其他为无效类型0</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token number">0</span> <span class="token comment">/* INVALID */</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="vue3响应式原理实现"><a href="#vue3响应式原理实现" class="header-anchor">#</a> <strong>vue3响应式原理实现</strong></h3> <p>Vue2 使用的是 Object.defineProperty，Vue3 使用的是 Proxy代理对象</p> <p><strong>Vue 2的不足</strong></p> <ol><li><p>Object.defineProperty只能劫持对象中预先设置好的数据，新增的数据需要Vue.Set(xxx)</p></li> <li><p>数组只能操作七种方法，修改某一项值无法劫持。数组的length修改也无法劫持</p></li></ol> <p><strong>响应式简单实现</strong></p> <ul><li><p>reactive.js</p> <p>对数据进行Proxy代理并通过辅助函数收集依赖、触发依赖更新</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> track<span class="token punctuation">,</span> trigger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./effect.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">isObject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">reactive</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 读取值的时候收集依赖</span>
            <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果是深层次对象，则递归调用reactive</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// set需要返回布尔值</span>
        <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Reflect.set返回布尔值，表示set是否成功</span>
            <span class="token keyword">let</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 修改值的时候触发依赖更新</span>
            <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><ul><li><p>effect.js</p> <p>通过weakMap、map、set的组合数据结构，收集依赖、触发依赖更新</p></li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">let</span> activeEffect<span class="token punctuation">;</span>
<span class="token comment">// 副作用函数</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">effect</span> <span class="token operator">=</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">_effect</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        activeEffect <span class="token operator">=</span> _effect<span class="token punctuation">;</span>
        <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">_effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 收集依赖</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">track</span> <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.获取第一层数据结构，通过weakMap的key获取map。</span>
    <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1.1第一次取不到值，初始化map，并通过target关联weakMap和map。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> depsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 1.2非第一次，可以获取到map</span>
    <span class="token keyword">let</span> deps <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.获取第二层数据结构。通过map的key获取set。</span>
    <span class="token comment">// 2.1 第一次获取不到值，初始化set，并通过key关联map和set。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> deps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.收集副作用函数</span>
    deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 触发更新</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">trigger</span> <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.通过weakMap和target找到map</span>
    <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2.通过map和key找到set</span>
        <span class="token keyword">const</span> deps <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>整个数据结构如图：</p> <p><img src="https://cdn.jsdelivr.net/gh/rookiepjx/image-bed/img/20240424200149.png" alt=""></p> <p>index.html</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">import</span> <span class="token punctuation">{</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./reactive.js&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">import</span> <span class="token punctuation">{</span> effect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./effect.js&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;James&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
        <span class="token literal-property property">form</span><span class="token operator">:</span><span class="token punctuation">{</span>
          <span class="token literal-property property">data</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token literal-property property">address</span><span class="token operator">:</span><span class="token string">'LA'</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>
          <span class="token string">&quot;#app&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> --- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">---</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span>form<span class="token punctuation">.</span>data<span class="token punctuation">.</span>address<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        user<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;LeBron James&quot;</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token string">&quot;38&quot;</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span>form<span class="token punctuation">.</span>data<span class="token punctuation">.</span>address <span class="token operator">=</span> <span class="token string">'New York'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><h3 id="computed实现"><a href="#computed实现" class="header-anchor">#</a> <strong>computed实现</strong></h3> <p>源码:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">computed</span><span class="token punctuation">(</span>getterOrOptions<span class="token punctuation">,</span> debugOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> getter<span class="token punctuation">;</span>
    <span class="token keyword">let</span> setter<span class="token punctuation">;</span>
    <span class="token keyword">const</span> onlyGetter <span class="token operator">=</span> shared<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>getterOrOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>onlyGetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        getter <span class="token operator">=</span> getterOrOptions<span class="token punctuation">;</span>
        <span class="token function-variable function">setter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Write operation failed: computed value is readonly'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        getter <span class="token operator">=</span> getterOrOptions<span class="token punctuation">.</span>get<span class="token punctuation">;</span>
        setter <span class="token operator">=</span> getterOrOptions<span class="token punctuation">.</span>set<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 通过ComputedRefImpl类实现</span>
    <span class="token keyword">const</span> cRef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComputedRefImpl</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> setter<span class="token punctuation">,</span> onlyGetter <span class="token operator">||</span> <span class="token operator">!</span>setter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>debugOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cRef<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>onTrack <span class="token operator">=</span> debugOptions<span class="token punctuation">.</span>onTrack<span class="token punctuation">;</span>
        cRef<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>onTrigger <span class="token operator">=</span> debugOptions<span class="token punctuation">.</span>onTrigger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cRef<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">ComputedRefImpl</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> _setter<span class="token punctuation">,</span> isReadonly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_setter <span class="token operator">=</span> _setter<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 脏值检测，默认为true</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>__v_isRef <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// 传入scheduler函数，当依赖变化是修改dirty为true，ComputedRefImpl中get函数将重新计算值并缓存</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>_dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token function">triggerRefValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">&quot;__v_isReadonly&quot;</span> <span class="token comment">/* IS_READONLY */</span><span class="token punctuation">]</span> <span class="token operator">=</span> isReadonly<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// the computed ref may get wrapped by other proxies e.g. readonly() #3376</span>
        <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">trackRefValue</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>_dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            self<span class="token punctuation">.</span>_dirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            self<span class="token punctuation">.</span>_value <span class="token operator">=</span> self<span class="token punctuation">.</span>effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_setter</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>computed简易实现</strong></p> <p>computed.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> effect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./effect&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">computed</span> <span class="token operator">=</span> <span class="token punctuation">(</span>getter<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> _value <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      _dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> cacheValue<span class="token punctuation">;</span>
  <span class="token keyword">let</span> _dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token keyword">class</span> <span class="token class-name">ComputedRefImpl</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 脏值检测实现缓存，如果dirty为true则读取缓存</span>
      <span class="token comment">// 如果只是这样的话，第一次之后dirty永远为false，最新的值不会更新</span>
        
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cacheValue <span class="token operator">=</span> <span class="token function">_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _dirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> cacheValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ComputedRefImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><strong>如果只是以上的话，第一次之后dirty永远为false，最新的值不会更新</strong></p> <p>还需要在依赖发生变化的时候，将dirty修改为true，并重新计算值</p> <p>实现原理基于响应式实现原理，需要对响应式实现代码中effect.js进行部分改造</p> <p>effect.js</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 加入computed版本</span>
<span class="token keyword">interface</span> <span class="token class-name">Options</span> <span class="token punctuation">{</span>
  scheduler<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> activeEffect<span class="token punctuation">;</span>
<span class="token comment">// 副作用函数</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">effect</span> <span class="token operator">=</span> <span class="token punctuation">(</span>fn<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> options<span class="token operator">:</span> Options<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">_effect</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    activeEffect <span class="token operator">=</span> _effect<span class="token punctuation">;</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 改动点1：需要将options属性添加到_effect</span>
  _effect<span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token function">_effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> _effect<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 收集依赖</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">track</span> <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.获取第一层数据结构，通过weakMap的key获取map。</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 1.1第一次取不到值，初始化map，并通过target关联weakMap和map。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> depsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 1.2非第一次，可以获取到map</span>
  <span class="token keyword">let</span> deps <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2.获取第二层数据结构。通过map的key获取set。</span>
  <span class="token comment">// 2.1 第一次获取不到值，初始化set，并通过key关联map和set。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> deps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 3.收集副作用函数</span>
  deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 触发更新</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">trigger</span> <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.通过weakMap和target找到map</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2.通过map和key找到set</span>
    <span class="token keyword">const</span> deps <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 改动点2：更新依赖时，需要触发scheduler函数</span>
      deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token operator">?.</span>options<span class="token operator">?.</span>scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          effect<span class="token operator">?.</span>options<span class="token operator">?.</span>scheduler<span class="token operator">?.</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="样式bem架构"><a href="#样式bem架构" class="header-anchor">#</a> 样式BEM架构</h3> <p>bem架构是一种css架构 ，<strong>oocss 实现的一种 （面向对象css） ，</strong><code>BEM</code>实际上是<code>block</code>、<code>element</code>、<code>modifier</code>的缩写，分别为块层、元素层、修饰符层，element UI 也使用的是这种架构。</p> <p>BEM 命名约定的模式：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.block</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
 
<span class="token selector">.block__element</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
 
<span class="token selector">.block--modifier</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>sass 简易实现 bem 架构</p> <div class="language-scss extra-class"><pre class="language-scss"><code><span class="token property"><span class="token variable">$namespace</span></span><span class="token punctuation">:</span><span class="token string">'xm'</span> <span class="token statement keyword">!default</span><span class="token punctuation">;</span> <span class="token comment">// 命名空间</span>
<span class="token property"><span class="token variable">$block-sel</span></span><span class="token punctuation">:</span> <span class="token string">&quot;-&quot;</span> <span class="token statement keyword">!default</span><span class="token punctuation">;</span> <span class="token comment">// block连接符</span>
<span class="token property"><span class="token variable">$element-sel</span></span><span class="token punctuation">:</span> <span class="token string">&quot;__&quot;</span> <span class="token statement keyword">!default</span><span class="token punctuation">;</span> <span class="token comment">// element连接符</span>
<span class="token property"><span class="token variable">$modifier-sel</span></span><span class="token punctuation">:</span> <span class="token string">&quot;--&quot;</span> <span class="token statement keyword">!default</span><span class="token punctuation">;</span> <span class="token comment">// modifier连接符</span>

<span class="token keyword">@mixin</span> <span class="token selector">bfc </span><span class="token punctuation">{</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
    <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">//混入</span>
<span class="token keyword">@mixin</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token variable">$block</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token property"><span class="token variable">$B</span></span><span class="token punctuation">:</span> <span class="token variable">$namespace</span> <span class="token operator">+</span> <span class="token variable">$block-sel</span> <span class="token operator">+</span> <span class="token variable">$block</span><span class="token punctuation">;</span> <span class="token comment">//变量</span>
   <span class="token selector">.<span class="token variable">#{$B}</span></span><span class="token punctuation">{</span> <span class="token comment">//插值语法#{}</span>
     <span class="token keyword">@content</span><span class="token punctuation">;</span> <span class="token comment">//内容替换，类似slot</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">@mixin</span> <span class="token selector">flex </span><span class="token punctuation">{</span>
    <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">@mixin</span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token variable">$element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token property"><span class="token variable">$selector</span></span><span class="token punctuation">:</span>&amp;<span class="token punctuation">;</span> <span class="token comment">// 获取父元素选择器</span>
    <span class="token atrule"><span class="token rule">@at-root</span></span> <span class="token punctuation">{</span> <span class="token comment">// at-root跳出父元素选择器嵌套</span>
        #<span class="token punctuation">{</span><span class="token variable">$selector</span> <span class="token operator">+</span> <span class="token variable">$element-sel</span> <span class="token operator">+</span> <span class="token variable">$element</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
            <span class="token keyword">@content</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">@mixin</span> <span class="token function">m</span><span class="token punctuation">(</span><span class="token variable">$modifier</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token property"><span class="token variable">$selector</span></span><span class="token punctuation">:</span>&amp;<span class="token punctuation">;</span>
    <span class="token atrule"><span class="token rule">@at-root</span></span> <span class="token punctuation">{</span>
        #<span class="token punctuation">{</span><span class="token variable">$selector</span> <span class="token operator">+</span> <span class="token variable">$modifier-sel</span> <span class="token operator">+</span> <span class="token variable">$modifier</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
            <span class="token keyword">@content</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>vite全局配置引用BEM架构</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vite'</span>
<span class="token keyword">import</span> vue <span class="token keyword">from</span> <span class="token string">'@vitejs/plugin-vue'</span>
 
<span class="token comment">// https://vitejs.dev/config/</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">css</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">preprocessorOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">scss</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">additionalData</span><span class="token operator">:</span> <span class="token string">&quot;@import './src/bem.scss';&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Vue 组件用法</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>xm-wraps<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Menu</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Menu</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>xm-wraps__right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Header</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Header</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Content</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Content</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span>
<span class="token keyword">import</span> Menu <span class="token keyword">from</span> <span class="token string">'./Menu/index.vue'</span>
<span class="token keyword">import</span> Content <span class="token keyword">from</span> <span class="token string">'./Content/index.vue'</span>
<span class="token keyword">import</span> Header <span class="token keyword">from</span> <span class="token string">'./Header/index.vue'</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>scss<span class="token punctuation">&quot;</span></span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token atrule"><span class="token rule">@include</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token string">'wraps'</span><span class="token punctuation">)</span></span><span class="token punctuation">{</span>
    <span class="token atrule"><span class="token rule">@include</span> bfc<span class="token punctuation">;</span></span>
    <span class="token atrule"><span class="token rule">@include</span> flex<span class="token punctuation">;</span></span>
    <span class="token atrule"><span class="token rule">@include</span> <span class="token function">e</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span></span><span class="token punctuation">{</span>
        <span class="token property">flex</span><span class="token punctuation">:</span>1<span class="token punctuation">;</span>
        <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
        <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="自定义指令"><a href="#自定义指令" class="header-anchor">#</a> 自定义指令</h3> <p>Vue3指令的钩子函数：</p> <ul><li>created：元素初始化的时候</li> <li>beforeMount： 指令绑定到元素后调用 只调用一次</li> <li>mounted： 元素插入父级dom调用</li> <li>beforeUpdate： 元素被更新之前调用</li> <li>update： 这个周期方法被移除 改用updated</li> <li>beforeUnmount： 在元素被移除前调用</li> <li>unmounted： 指令被移除后调用 只调用一次</li></ul> <p>Vue2指令的钩子函数：</p> <ul><li>bind：当指令绑定在 HTML 元素上时触发</li> <li>inserted：当指令绑定的元素插入到父节点中的时候触发</li> <li>update：当指令绑定的元素状态/样式、内容(这里指元素绑定的 vue 数据) 发生改变时触发</li> <li>componentUpdated：当 update() 执行完毕之后触发</li> <li>unbind：当指令绑定的元素从 dom 中删除时触发</li></ul> <p><strong>基本使用</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>button @click<span class="token operator">=</span><span class="token string">&quot;show = !show&quot;</span><span class="token operator">&gt;</span>开关<span class="token punctuation">{</span><span class="token punctuation">{</span>show<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>Dialog  v<span class="token operator">-</span>move<span class="token operator">-</span>directive<span class="token operator">=</span><span class="token string">&quot;{background:'green',flag:show}&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Dialog<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token keyword">const</span> <span class="token literal-property property">vMoveDirective</span><span class="token operator">:</span> Directive <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">created</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;初始化====&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">beforeMount</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在元素上做些操作</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;初始化一次=======&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">dir</span><span class="token operator">:</span> DirectiveBinding<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>background <span class="token operator">=</span> dir<span class="token punctuation">.</span>value<span class="token punctuation">.</span>background<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;初始化========&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">beforeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;更新之前&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;更新结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">beforeUnmount</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;======&gt;卸载之前&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">unmounted</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;======&gt;卸载完成&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>生命周期钩子参数详解</strong></p> <ol><li><p>el  当前绑定的DOM 元素</p></li> <li><p>binding</p> <ul><li>instance：使用指令的组件实例。</li> <li>value：传递给指令的值。例如，在 v-my-directive=&quot;1 + 1&quot; 中，该值为 2。</li> <li>oldValue：先前的值，仅在 beforeUpdate 和 updated 中可用。无论值是否有更改都可用。</li> <li>arg：传递给指令的参数(如果有的话)。例如在 v-my-directive:foo 中，arg 为 &quot;foo&quot;。</li> <li>modifiers：包含修饰符(如果有的话) 的对象。例如在 v-my-directive.foo.bar 中，修饰符对象为 {foo: true，bar: true}。</li> <li>dir：一个对象，在注册指令时作为参数传递。</li></ul></li> <li><p>vnode：代表绑定元素的底层 VNode。</p></li> <li><p>prevNode：之前的渲染中代表指令所绑定元素的 VNode。仅在 beforeUpdate 和 updated 钩子中可用</p></li></ol> <p><strong>函数简写</strong></p> <p>你可能想在 <code>mounted</code> 和 <code>updated</code> 时触发相同行为，而不关心其他的钩子函数。那么你可以通过将这个函数模式实现</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token literal-property property">vMove</span><span class="token operator">:</span> <span class="token function-variable function">Directive</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> <span class="token literal-property property">binding</span><span class="token operator">:</span> DirectiveBinding<span class="token operator">&lt;</span>Dir<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>background <span class="token operator">=</span> binding<span class="token punctuation">.</span>value<span class="token punctuation">.</span>background
<span class="token punctuation">}</span>
</code></pre></div><p><strong>案例</strong></p> <h4 id="_1-自定义拖拽指令案例"><a href="#_1-自定义拖拽指令案例" class="header-anchor">#</a> 1.自定义拖拽指令案例</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div v<span class="token operator">-</span>move <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;box&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;header&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      内容
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
 
<span class="token operator">&lt;</span>script setup lang<span class="token operator">=</span><span class="token string">'ts'</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Directive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token literal-property property">vMove</span><span class="token operator">:</span> Directive <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> HTMLElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> moveEl <span class="token operator">=</span> el<span class="token punctuation">.</span>firstElementChild <span class="token keyword">as</span> HTMLElement<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">mouseDown</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">e</span><span class="token operator">:</span> MouseEvent</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//鼠标点击物体那一刻相对于物体左侧边框的距离=点击时的位置相对于浏览器最左边的距离-物体左边框相对于浏览器最左边的距离</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>clientX<span class="token punctuation">,</span> e<span class="token punctuation">.</span>clientY<span class="token punctuation">,</span> <span class="token string">&quot;-----起始&quot;</span><span class="token punctuation">,</span> el<span class="token punctuation">.</span>offsetLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> <span class="token constant">X</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>clientX <span class="token operator">-</span> el<span class="token punctuation">.</span>offsetLeft<span class="token punctuation">;</span>
      <span class="token keyword">let</span> <span class="token constant">Y</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>clientY <span class="token operator">-</span> el<span class="token punctuation">.</span>offsetTop<span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token function-variable function">move</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">e</span><span class="token operator">:</span> MouseEvent</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> e<span class="token punctuation">.</span>clientX <span class="token operator">-</span> <span class="token constant">X</span> <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span><span class="token punctuation">;</span>
        el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> e<span class="token punctuation">.</span>clientY <span class="token operator">-</span> <span class="token constant">Y</span> <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>clientX<span class="token punctuation">,</span> e<span class="token punctuation">.</span>clientY<span class="token punctuation">,</span> <span class="token string">&quot;---改变&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;mousemove&quot;</span><span class="token punctuation">,</span> move<span class="token punctuation">)</span><span class="token punctuation">;</span>
      document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;mouseup&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        document<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;mousemove&quot;</span><span class="token punctuation">,</span> move<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    moveEl<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;mousedown&quot;</span><span class="token punctuation">,</span> mouseDown<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><h4 id="_2-权限按钮案例"><a href="#_2-权限按钮案例" class="header-anchor">#</a> 2.权限按钮案例</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btns&quot;</span><span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>button v<span class="token operator">-</span>has<span class="token operator">-</span>show<span class="token operator">=</span><span class="token string">&quot;'shop:create'&quot;</span><span class="token operator">&gt;</span>创建<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
 
       <span class="token operator">&lt;</span>button v<span class="token operator">-</span>has<span class="token operator">-</span>show<span class="token operator">=</span><span class="token string">&quot;'shop:edit'&quot;</span><span class="token operator">&gt;</span>编辑<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
 
       <span class="token operator">&lt;</span>button v<span class="token operator">-</span>has<span class="token operator">-</span>show<span class="token operator">=</span><span class="token string">&quot;'shop:delete'&quot;</span><span class="token operator">&gt;</span>删除<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
 
<span class="token operator">&lt;</span>script setup lang<span class="token operator">=</span><span class="token string">'ts'</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> reactive<span class="token punctuation">,</span>  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> type <span class="token punctuation">{</span>Directive<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token comment">//permission</span>
localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'userId'</span><span class="token punctuation">,</span><span class="token string">'xiaoman-zs'</span><span class="token punctuation">)</span>
 
<span class="token comment">//mock后台返回的数据</span>
<span class="token keyword">const</span> permission <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'xiaoman-zs:shop:edit'</span><span class="token punctuation">,</span>
    <span class="token string">'xiaoman-zs:shop:create'</span><span class="token punctuation">,</span>
    <span class="token string">'xiaoman-zs:shop:delete'</span>
<span class="token punctuation">]</span>
<span class="token keyword">const</span> userId <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'userId'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> string
<span class="token keyword">const</span> <span class="token literal-property property">vHasShow</span><span class="token operator">:</span>Directive<span class="token operator">&lt;</span>HTMLElement<span class="token punctuation">,</span>string<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span>bingding</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>permission<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>userId<span class="token operator">+</span><span class="token string">':'</span><span class="token operator">+</span> bingding<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><h4 id="_3-图片懒加载案例"><a href="#_3-图片懒加载案例" class="header-anchor">#</a> 3.图片懒加载案例</h4> <p><code>IntersectionObserver</code> API参考MDN文档 https://developer.mozilla.org/zh-CN/docs/Web/API/IntersectionObserver</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">&quot;item in arr&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>img height<span class="token operator">=</span><span class="token string">&quot;500&quot;</span> <span class="token operator">:</span>data<span class="token operator">-</span>index<span class="token operator">=</span><span class="token string">&quot;item&quot;</span> v<span class="token operator">-</span>lazy<span class="token operator">=</span><span class="token string">&quot;item&quot;</span> width<span class="token operator">=</span><span class="token string">&quot;360&quot;</span> alt<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
 
<span class="token operator">&lt;</span>script setup lang<span class="token operator">=</span><span class="token string">'ts'</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> type <span class="token punctuation">{</span> Directive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">const</span> <span class="token literal-property property">images</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> string <span class="token punctuation">}</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span><span class="token function">globEager</span><span class="token punctuation">(</span><span class="token string">'./assets/images/*.*'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> arr <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> v<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
 
<span class="token keyword">let</span> <span class="token literal-property property">vLazy</span><span class="token operator">:</span> Directive<span class="token operator">&lt;</span>HTMLImageElement<span class="token punctuation">,</span> string<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./assets/vue.svg'</span><span class="token punctuation">)</span>
    el<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">.</span>default<span class="token punctuation">;</span>
	<span class="token comment">// IntersectionObserver API可以用来监听目标元素是否处于可视窗口内</span>
    <span class="token keyword">let</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entries</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> el<span class="token punctuation">)</span>
        <span class="token comment">// 当目标元素的可见部分被根元素或 viewport 部分遮挡时，intersectionRatio 可能大于 0，但 isIntersecting 可能为 false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>intersectionRatio <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> entries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isIntersecting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                el<span class="token punctuation">.</span>src <span class="token operator">=</span> binding<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
                <span class="token comment">// 销毁监听</span>
                observer<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 开始监听目标元素</span>
    observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
 
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><h2 id="vue3-zxq"><a href="#vue3-zxq" class="header-anchor">#</a> Vue3-zxq</h2> <h3 id="浏览器环境访问vue实例对象"><a href="#浏览器环境访问vue实例对象" class="header-anchor">#</a> 浏览器环境访问Vue实例对象</h3> <p>F12鼠标选中vue实例挂载节点（#app），此时浏览器会默认将选中的节点元素绑定在<code>$0</code>变量上，通过<code>$0.__vue__</code>即可访问到vue实例对象。</p> <h3 id="组件样式之css-module"><a href="#组件样式之css-module" class="header-anchor">#</a> 组件样式之CSS Module</h3> <p>常用的组件样式写法：</p> <ul><li><p>全局样式 </p><style></style><p></p></li> <li><p>局部样式 </p><style scope=""></style><p></p></li> <li><p>外部导入css</p></li> <li><p>css in js 如 styled-component库</p></li> <li><p>css module</p> <p>将 css 的选择器转换成惟一的字符串，运用到 dom。是在用算法命名，记录了人的命名到算法命名的 map 表
简单来说就是 将class命名通过算法<strong>hash</strong> 产生唯一的类名。</p> <p>使用时style标签添加module配置，在编写class时通过<code>$style.样式名</code>动态绑定</p></li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>$style.title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">module</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
	<span class="token selector">.title</span> <span class="token punctuation">{</span>
		<span class="token property">color</span><span class="token punctuation">:</span>red<span class="token punctuation">;</span>
		<span class="token property">font-size</span><span class="token punctuation">:</span>20px<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="vue3-2-css绑定响应式数据"><a href="#vue3-2-css绑定响应式数据" class="header-anchor">#</a> vue3.2-css绑定响应式数据</h3> <p>在<strong>vue3.2</strong>版本后，支持css绑定响应式数据。</p> <p>原理是vue会将v-bind绑定的响应式数据转成<strong>css变量</strong>，并放在组件根元素的style属性中</p> <div class="language- extra-class"><pre class="language-text"><code>export default {
	data() {
		return {
			// 也可以绑定computed
			degree:0
		}
	}
}

&lt;style scoped&gt;
	.a {
		transform:rotate(v-bind(degree + 'deg'));
	}
&lt;/style&gt;
</code></pre></div><h3 id="组件支持v-model"><a href="#组件支持v-model" class="header-anchor">#</a> 组件支持v-model</h3> <ul><li>单个v-model指令</li></ul> <p>子组件需要配置<code>props: [&quot;modelValue&quot;]</code>和<code>emits: [&quot;update:modelValue&quot;]</code>。（固定写法）</p> <p>子组件元素需要添加<code>:value=&quot;modelValue&quot; @input=&quot;$emit('update:modelValue', $event.target.value)&quot;</code></p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!--父组件--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--组件使用v-model--&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SearchInput</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>searchTerm<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{ searchTerm }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> SearchInput <span class="token keyword">from</span> <span class="token string">&quot;./components/SearchInput.vue&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    SearchInput<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">searchTerm</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--子组件--&gt;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>搜索：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
      <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>modelValue<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">@input</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>$emit('update:modelValue', $event.target.value)<span class="token punctuation">&quot;</span></span>
    <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;modelValue&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">emits</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;update:modelValue&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>多个v-model指令</li></ul> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!--父组件--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!-- v-model 后面的参数必须和子组件接收的属性名相同，例如 searchTerm --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SearchInput</span>
        <span class="token attr-name"><span class="token namespace">v-model:</span>searchTerm</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>searchTerm<span class="token punctuation">&quot;</span></span>
        <span class="token attr-name"><span class="token namespace">v-model:</span>category</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>category<span class="token punctuation">&quot;</span></span>
      <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>splitLine<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>搜索词：{{ searchTerm }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>类别：{{ category }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> SearchInput <span class="token keyword">from</span> <span class="token string">&quot;./components/SearchInput.vue&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    SearchInput<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// 名字无需和 SearchInput 中的属性名相同</span>
      <span class="token comment">// 例如这里可以叫 searchQuery，</span>
      <span class="token literal-property property">searchTerm</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">category</span><span class="token operator">:</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--子组件--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span>
    <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>搜索：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span>
    <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
      <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>searchTerm<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">@input</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>$emit('update:searchTerm', $event.target.value)<span class="token punctuation">&quot;</span></span>
    <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>类别：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span>
      <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>category<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">@change</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>$emit('update:category', $event.target.value)<span class="token punctuation">&quot;</span></span>
    <span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>default<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>默认<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fontend<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>前端<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>backend<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>后端<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fullstack<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>全栈<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;searchTerm&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;category&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">emits</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;update:searchTerm&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;update:category&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><h3 id="pinia"><a href="#pinia" class="header-anchor">#</a> Pinia</h3> <ol><li>什么是pinia?</li></ol> <p>Pinia 是 Vue.js 团队成员专门为 Vue 开发的一个全新的状态管理库。</p> <ol start="2"><li><p>用途及使用场景</p> <p>用于集中式存储管理 应用的所有组件的状态，并以相应的规则保证状态以一种可预测的方式发生变化。</p> <p>通过将全局共享数据抽离组件本身，集中管理状态，解决多个组件或页面之间数据传递和共享复杂繁琐的问题。例如用户登录状态、用户名、头像、地理位置等信息的共享。</p></li> <li><p>优点：</p></li></ol> <ul><li><p>完整TS支持配合Vue3开发</p></li> <li><p>轻量化，压缩后体积只有1KB左右</p></li> <li><p>去除mutations概念，只有state,getter,actions</p> <ul><li>vuex中需要dispatch action,action中commit mutation，mutation中进行state修改，繁琐</li></ul></li> <li><p>actions支持同步和异步操作</p></li> <li><p>通过js命名划分模块，设计扁平化没有模块嵌套，store之间相互独立，自由使用</p> <ul><li>vuex需要建立module</li></ul></li> <li><p>无需手动导入添加store,一旦创建自动注册</p></li> <li><p>支持vue2和vue3</p></li> <li><p>支持配合vue-devtools使用，方便追踪和观察状态的变化</p></li> <li><p>模块热更新</p></li> <li><p>插件扩展</p></li> <li><p>支持SSR</p></li></ul> <ol start="3"><li>pinia的使用</li></ol> <p>安装</p> <div class="language- extra-class"><pre class="language-text"><code>npm install pinia
yarn add pinia
</code></pre></div><p>main.ts中使用</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createPinia<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;pinia&quot;</span>
<span class="token keyword">import</span> <span class="token string">'./style.css'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>

<span class="token comment">/**
 * 调用createPinia hook
 * 为应用创建一个pinia实例对象来使用
 */</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createPinia</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 注册插件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre></div><p>修改state</p> <ul><li>直接修改</li></ul> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">updateUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  user<span class="token punctuation">.</span>age<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在vuex中不允许直接修改，需要通过提交mutation修改state</p> <ul><li>$patch对象修改</li></ul> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">updateUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  user<span class="token punctuation">.</span><span class="token function">$patch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  	name<span class="token operator">:</span><span class="token string">&quot;Rose&quot;</span><span class="token punctuation">,</span>
  	age<span class="token operator">:</span><span class="token number">20</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>$patch函数修改</li></ul> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">updateUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  user<span class="token punctuation">.</span><span class="token function">$patch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  	state<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Rose&quot;</span>
  	state<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">20</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>$state修改</li></ul> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">updateUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  user<span class="token punctuation">.</span>$state <span class="token operator">=</span> <span class="token punctuation">{</span>
  	name<span class="token operator">:</span><span class="token string">&quot;Rose&quot;</span><span class="token punctuation">,</span>
  	age<span class="token operator">:</span><span class="token number">20</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这种方式必须传入state中所有属性，将state完全更新</p> <ul><li>action修改</li></ul> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">updateUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>源码浅析</li></ol> <p>store在经过解构后会失去响应式</p> <p>pinia提供了storeToRefs函数可以将结构后的store转为响应式，核心原理类似于vue中的toRefs</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token function">useUserStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>name<span class="token punctuation">,</span>age<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">storeToRefs</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">storeToRefs</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 从proxy对象转成object对象</span>
	store <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> refs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> value <span class="token operator">=</span> store<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isReactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			refs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">toRef</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> refs<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>$subscribe和$onAction</p> <p>可以通过 store 的 <code>$subscribe()</code> 方法查看状态及其变化，类似于 Vuex 的 subscribe 方法</p> <p>默认情况下，<em>state subscriptions</em> 绑定到添加它们的组件（如果 store 位于组件的 <code>setup()</code> 中）。 意思是，当组件被卸载时，它们将被自动删除。 如果要在卸载组件后保留它们，请将 <code>{ detached: true }</code> 作为第二个参数传递给 <em>detach</em> 当前组件的 <em>state subscription</em></p> <p>可以使用 <code>store.$onAction()</code> 订阅 action 及其结果。 传递给它的回调在 action 之前执行。 <code>after</code> 处理 Promise 并允许您在 action 完成后执行函数。 以类似的方式，<code>onError</code> 允许您在处理中抛出错误。</p> <p>默认情况下，<em>action subscriptions</em> 绑定到添加它们的组件（如果 store 位于组件的 <code>setup()</code> 内）。 意思是，当组件被卸载时，它们将被自动删除。 如果要在卸载组件后保留它们，请将 <code>true</code> 作为第二个参数传递给当前组件的 <em>detach</em> <em>action subscription</em></p> <ol start="5"><li>持久化：</li></ol> <ul><li>插件</li> <li>$subscribe订阅存储</li></ul> <h3 id="mixins的覆盖与合并"><a href="#mixins的覆盖与合并" class="header-anchor">#</a> Mixins的覆盖与合并</h3> <p>data，computed，methods,component,props中的属性会合并，如果属性名相同，组件自身的会覆盖mixins中的</p> <p>如果是生命周期函数，组件的和mixins中的都会执行，mixins中的优先执行</p> <h3 id="响应式实现案例"><a href="#响应式实现案例" class="header-anchor">#</a> 响应式实现案例</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">b</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义WeakMap存储依赖 obj -&gt; obj的key -&gt; 依赖key的functions</span>
<span class="token comment">// weakMap允许键为对象，weakMap在key为对象时不会影响垃圾回收，从而影响性能问题</span>
<span class="token keyword">const</span> observers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

observers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 访问对象属性时currentObserver不为null则添加依赖</span>
<span class="token keyword">let</span> currentObserver <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  currentObserver <span class="token operator">=</span> fn<span class="token punctuation">;</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  currentObserver <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// Proxy代理普通对象并拦截get set方法</span>
<span class="token keyword">let</span> reactiveObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span><span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">访问了</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">的属性</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,值为</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>currentObserver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> targetObserver <span class="token operator">=</span> observers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
      <span class="token comment">// 如果当前属性已经有其他依赖函数,则追加到依赖中</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>targetObserver<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				targetObserver<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>currentObserver<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// 如果当前属性没有其他依赖函数,则新增到依赖中</span>
				targetObserver<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>currentObserver<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> observersForKey <span class="token operator">=</span> observers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">修改了</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">的属性</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,值为</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 先修改才能在遍历调用依赖函数时，访问到最新的值</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    observersForKey<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reactiveObj<span class="token punctuation">.</span>a <span class="token operator">+</span> reactiveObj<span class="token punctuation">.</span>b<span class="token punctuation">)</span>
<span class="token punctuation">}</span>



<span class="token comment">// 调用observe方法 并在get拦截器中添加依赖</span>
<span class="token function">observe</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 测试修改代理对象的属性时，自动调用sum 实现响应式</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  reactiveObj<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  reactiveObj<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="路由导航守卫"><a href="#路由导航守卫" class="header-anchor">#</a> 路由导航守卫</h3> <p><strong>全局导航守卫</strong>：</p> <ul><li><code>beforeEach</code></li> <li><code>beforeResolve</code></li> <li><code>afterEach</code></li></ul> <p><strong>路由导航守卫</strong>：</p> <ul><li><code>beforeEnter</code></li></ul> <p><strong>组件导航守卫</strong>：</p> <ul><li><p><code>beforeRouteEnter</code></p> <p>此守卫 <strong>不能</strong> 访问 <code>this</code>，因为守卫在导航确认前被调用，因此即将登场的新组件还没被创建。可以通过传一个回调给 <code>next</code> 来访问组件实例</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">beforeRouteEnter</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token parameter">vm</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过 `vm` 访问组件实例</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>beforeRouteUpdate</code></p></li> <li><p><code>beforeRouteLeave</code></p> <p>对于 <code>beforeRouteUpdate</code> 和 <code>beforeRouteLeave</code> 来说，<code>this</code> 已经可用了，所以<em>不支持</em> 传递回调，因为没有必要了</p></li></ul> <p><strong>导航守卫执行顺序</strong></p> <ul><li><p>导航被触发</p></li> <li><p>组件beforeRouteLeave （如果有）</p></li> <li><p>全局beforeEach</p></li> <li><p>复用组件中beforeRouteUpdate</p></li> <li><p>路由对象beforeEnter</p></li> <li><p>解析异步导航组件</p></li> <li><p>组件中beforeRouteEnter</p></li> <li><p>全局beforeResolve</p></li> <li><p>确认导航并发生页面跳转</p></li> <li><p>全局afterEach</p></li> <li><p>更新DOM</p></li> <li><p>组件中的beforeRouteEnter的next回调函数，<strong>创建好的组件实例会作为回调函数的参数传入</strong></p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5ab2ec69.js" defer></script><script src="/assets/js/2.eeb24f79.js" defer></script><script src="/assets/js/18.9da1d026.js" defer></script>
  </body>
</html>
